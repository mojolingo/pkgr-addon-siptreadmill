#!/bin/bash

set -e

. ${INSTALLER_DIR}/wizard

CLI="${APP_NAME}"

# set cookie secret token
cookie_secret=$(${CLI} config:get COOKIE_SECRET || ${CLI} run rake -s secret | tail -1)
${CLI} config:set COOKIE_SECRET="$cookie_secret"

# Create database
apt-get -y install postgresql
sudo -u postgres createuser -D -A -P ${APP_NAME}
sudo -u postgres psql -c "alter user ${APP_NAME} with password '${APP_NAME}';"
sudo -u postgres createdb -O ${APP_NAME} ${APP_NAME}
${CLI} config:set DATABASE_URL="postgres://${APP_NAME}:${APP_NAME}@localhost/${APP_NAME}"

# prepare database
${CLI} run rake db:setup db:seed || true

# scale
${CLI} scale web=1 worker=1 || true

# restart
service ${APP_NAME} restart
